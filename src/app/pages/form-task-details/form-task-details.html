<div class="form-container">
  <!-- Loading State -->
  <div *ngIf="loading()" class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
    <p>{{ isEditMode() ? "Loading task..." : "Preparing form..." }}</p>
  </div>

  <!-- Form -->
  <div *ngIf="!loading()">
    <!-- Header -->
    <div class="form-header">
      <button mat-icon-button (click)="goBack()" [matTooltip]="'Back to tasks'">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="title-section">
        <h1>{{ isEditMode() ? 'Edit Task' : 'Create New Task' }}</h1>
        <p class="subtitle">{{ isEditMode() ? 'Update task details' : 'Add a new task to your project' }}</p>
      </div>
      <div class="header-actions" *ngIf="isEditMode() && currentTask()">
        <span class="task-id">{{ currentTask()?.uid }}</span>
        <button
          mat-icon-button
          [matTooltip]="'Delete task'"
          (click)="deleteTask()"
          class="delete-btn"
        >
          <mat-icon>delete</mat-icon>
        </button>
      </div>
    </div>

    <form [formGroup]="taskForm" (ngSubmit)="onSubmit()">
      <div class="form-grid">
        <!-- Left Column -->
        <div class="form-column">
          <mat-card class="form-section">
            <mat-card-header>
              <mat-card-title>Basic Information</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <!-- Title -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Title *</mat-label>
                <input
                  matInput
                  formControlName="title"
                  placeholder="Enter task title"
                  required
                />
                <mat-error *ngIf="taskForm.get('title')?.hasError('required')">
                  Title is required
                </mat-error>
                <mat-error *ngIf="taskForm.get('title')?.hasError('minlength')">
                  Title must be at least 3 characters
                </mat-error>
              </mat-form-field>

              <!-- Description -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Description</mat-label>
                <textarea
                  matInput
                  formControlName="description"
                  placeholder="Enter task description"
                  rows="4"
                ></textarea>
              </mat-form-field>

              <!-- Status (Only for edit mode) -->
              <mat-form-field
                appearance="outline"
                class="full-width"
                *ngIf="isEditMode()"
              >
                <mat-label>Status</mat-label>
                <mat-select formControlName="status">
                  <mat-option
                    *ngFor="let status of statusOptions"
                    [value]="status.value"
                  >
                    <div class="status-option">
                      <mat-icon>{{ getStatusIcon(status.value) }}</mat-icon>
                      {{ status.label }}
                    </div>
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </mat-card-content>
          </mat-card>

          <mat-card class="form-section">
            <mat-card-header>
              <mat-card-title>Assignment & Priority</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <!-- Priority -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Priority *</mat-label>
                <mat-select formControlName="priority" required>
                  <mat-option
                    *ngFor="let priority of priorityOptions"
                    [value]="priority.value"
                  >
                    <div class="priority-option">
                      <span
                        [class]="'priority-indicator ' + priority.value.toLowerCase()"
                      >
                        ‚óè
                      </span>
                      {{ priority.label }}
                    </div>
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="taskForm.get('priority')?.hasError('required')">
                  Priority is required
                </mat-error>
              </mat-form-field>

              <!-- Assignee -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Assignee</mat-label>
                <mat-select formControlName="assigneeId">
                  <mat-option value="">No assignee</mat-option>
                  <mat-option
                    *ngFor="let user of users"
                    [value]="user.id"
                    [disabled]="user.active === false"
                  >
                    <div class="user-option">
                      <div class="user-avatar">
                        <img
                          [src]="user.avatarUrl"
                          [alt]="user.name"
                          onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"
                        />
                        <span class="initials">{{ getInitials(user.name) }}</span>
                      </div>
                      <div class="user-info">
                        <span
                          class="user-name"
                          [class.inactive]="user.active === false"
                        >
                          {{ user.name }}
                        </span>
                        <span class="user-email">{{ user.email }}</span>
                      </div>
                    </div>
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <!-- Due Date -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Due Date *</mat-label>
                <input
                  matInput
                  [matDatepicker]="picker"
                  formControlName="dueDate"
                  required
                />
                <mat-hint>Select the deadline for this task</mat-hint>
                <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
                <mat-error *ngIf="taskForm.get('dueDate')?.hasError('required')">
                  Due date is required
                </mat-error>
              </mat-form-field>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Right Column -->
        <div class="form-column">
          <mat-card class="form-section">
            <mat-card-header>
              <mat-card-title>Tags</mat-card-title>
              <mat-card-subtitle>Organize your task with relevant tags</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <!-- Tag Input -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Add tags</mat-label>
                <input
                  matInput
                  [formControl]="tagControl"
                  [matAutocomplete]="auto"
                  placeholder="Type to add tags"
                  (keydown.enter)="addTag($event)"
                />
                <mat-autocomplete
                  #auto="matAutocomplete"
                  (optionSelected)="addTagFromOption($event)"
                >
                  <mat-option
                    *ngFor="let tag of filteredTags | async"
                    [value]="tag"
                  >
                    {{ tag }}
                  </mat-option>
                </mat-autocomplete>
              </mat-form-field>

              <!-- Current Tags -->
              <div class="tags-container" *ngIf="currentTags().length > 0">
                <mat-chip-set aria-label="Task tags">
                  <mat-chip
                    *ngFor="let tag of currentTags()"
                    (removed)="removeTag(tag)"
                    [removable]="true"
                  >
                    {{ tag }}
                    <mat-icon matChipRemove>cancel</mat-icon>
                  </mat-chip>
                </mat-chip-set>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Task Info (Edit Mode Only) -->
          <mat-card class="form-section" *ngIf="isEditMode() && currentTask()">
            <mat-card-header>
              <mat-card-title>Task Information</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Created</span>
                  <span class="info-value">{{
                    currentTask()?.createdAt | date: "MMM d, y, h:mm a"
                  }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Last Updated</span>
                  <span class="info-value">{{
                    currentTask()?.updatedAt | date: "MMM d, y, h:mm a"
                  }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Task ID</span>
                  <span class="info-value">{{ currentTask()?.uid }}</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" mat-stroked-button (click)="goBack()" class="cancel-btn">
          Cancel
        </button>
        <button
          type="submit"
          mat-raised-button
          color="primary"
          [disabled]="taskForm.invalid || submitting()"
          class="submit-btn"
        >
          <mat-icon *ngIf="submitting()">hourglass_empty</mat-icon>
          <mat-icon *ngIf="!submitting()">{{
            isEditMode() ? "update" : "add"
          }}</mat-icon>
          {{
            submitting()
              ? "Saving..."
              : isEditMode()
                ? "Update Task"
                : "Create Task"
          }}
        </button>
      </div>
    </form>
  </div>
</div>