<mat-card class="table-card">
  <div class="table-header">
    <h2>Tasks</h2>
    <div class="table-actions">
      <button mat-icon-button [matTooltip]="'Refresh'" (click)="onRefresh()">
        <mat-icon>refresh</mat-icon>
      </button>
      <button mat-icon-button [matTooltip]="'Export'" (click)="onExport()">
        <mat-icon>download</mat-icon>
      </button>
    </div>
  </div>

  <div class="table-container" [class.loading]="loading()">
    @if (loading()) {
    <div class="loading-overlay">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading tasks...</p>
    </div>
    }

    <table mat-table [dataSource]="dataSource" matSort class="tasks-table">
      <!-- ID Column -->
      <ng-container matColumnDef="uid">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
        <td mat-cell *matCellDef="let task">
          <span class="task-id">{{ task.uid }}</span>
        </td>
      </ng-container>

      <!-- Title Column -->
      <ng-container matColumnDef="title">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Title</th>
        <td mat-cell *matCellDef="let task">
          <div class="title-cell">
            <span class="title" [matTooltip]="task.title">{{ task.title }}</span>
            @if (task.tags && task.tags.length > 0) {
            <div class="tags">
              @for (tag of task.tags.slice(0, 3); track tag) {
              <mat-chip class="tag-chip">
                {{ tag }}
              </mat-chip>
              } @if (task.tags.length > 3) {
              <span class="more-tags"> +{{ task.tags.length - 3 }} more </span>
              }
            </div>
            }
          </div>
        </td>
      </ng-container>

      <!-- Assignee Column -->
      <ng-container matColumnDef="assignee">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Assignee</th>
        <td mat-cell *matCellDef="let task">
          @if (task.assignee) {
          <div class="assignee-cell">
            <div class="avatar" [class.inactive]="task.assignee.active === false">
              <img
                [src]="task.assignee.avatarUrl"
                [alt]="task.assignee.name"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"
              />
              <span class="initials">{{ getInitials(task.assignee.name) }}</span>
            </div>
            <div class="assignee-info">
              <span class="name" [class.inactive]="task.assignee.active === false">
                {{ task.assignee.name }}
              </span>
              <span class="email">{{ task.assignee.email }}</span>
            </div>
          </div>
          } @else {
          <div class="unassigned">
            <mat-icon>person_outline</mat-icon>
            <span>Unassigned</span>
          </div>
          }
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
        <td mat-cell *matCellDef="let task">
          <mat-chip [class]="'status-chip status-' + getStatusClass(task.status)">
            <mat-icon>{{ getStatusIcon(task.status) }}</mat-icon>
            {{ task.status }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Priority Column -->
      <ng-container matColumnDef="priority">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Priority</th>
        <td mat-cell *matCellDef="let task">
          <mat-chip [class]="'priority-chip priority-' + task.priority.toLowerCase()">
            {{ task.priority }}
          </mat-chip>
        </td>
      </ng-container>

      <!-- Due Date Column -->
      <ng-container matColumnDef="dueDate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Due Date</th>
        <td mat-cell *matCellDef="let task">
          <div class="due-date" [class.overdue]="isOverdue(task)">
            @if (isOverdue(task)) {
            <mat-icon class="overdue-icon">warning</mat-icon>
            }
            <span>{{ task.dueDate | date : 'MMM d, y' }}</span>
          </div>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let task">
          <button
            mat-icon-button
            [matMenuTriggerFor]="actionsMenu"
            [matMenuTriggerData]="{ task: task }"
          >
            <mat-icon>more_vert</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns()"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns()"
        class="table-row"
        (click)="onTaskView(row)"
        [matTooltip]="'Click to view details'"
      ></tr>
    </table>

    <!-- No Data State -->
    @if (!loading() && dataSource.data.length === 0) {
    <div class="no-data">
      <mat-icon>assignment</mat-icon>
      <h3>No tasks found</h3>
      <p>No tasks match your current filters. Try adjusting your search criteria.</p>
      <button mat-raised-button color="primary" (click)="onClearFilters()">Clear Filters</button>
    </div>
    }
  </div>

  <mat-paginator
    #paginator
    [pageSizeOptions]="paginatorOptions()"
    [pageSize]="pageSize()"
    showFirstLastButtons
    (page)="onPageChange($event)"
  >
  </mat-paginator>
</mat-card>

<!-- Actions Menu -->
<mat-menu #actionsMenu="matMenu">
  <ng-template matMenuContent let-task="task">
    <button mat-menu-item (click)="onTaskView(task)">
      <mat-icon>visibility</mat-icon>
      <span>View Details</span>
    </button>
    <button mat-menu-item (click)="onTaskEdit(task)">
      <mat-icon>edit</mat-icon>
      <span>Edit</span>
    </button>
    <button mat-menu-item (click)="onTaskDuplicate(task)">
      <mat-icon>content_copy</mat-icon>
      <span>Duplicate</span>
    </button>
    <mat-divider></mat-divider>
    <button mat-menu-item (click)="onTaskDelete(task)" class="delete-action">
      <mat-icon>delete</mat-icon>
      <span>Delete</span>
    </button>
  </ng-template>
</mat-menu>
